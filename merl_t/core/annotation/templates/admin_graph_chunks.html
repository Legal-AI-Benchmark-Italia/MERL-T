{% extends "base.html" %}

{% block title %}Gestione Chunk del Knowledge Graph - NER-Giuridico{% endblock %}
{% block page_id %}admin_graph_chunks{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3">
                <i class="fas fa-project-diagram me-2"></i> Gestione Chunk del Knowledge Graph
            </h1>
            <p class="text-muted">
                Crea, modifica e assegna chunk del Knowledge Graph agli annotatori per la validazione collaborativa.
            </p>
        </div>
    </div>
    
    <div class="row">
        <!-- Colonna sinistra: Lista chunk esistenti -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Chunk Esistenti</h5>
                    <div class="d-flex">
                        <select id="chunk-status-filter" class="form-select form-select-sm me-2">
                            <option value="all">Tutti gli stati</option>
                            <option value="pending">In attesa</option>
                            <option value="validated">Validati</option>
                            <option value="rejected">Respinti</option>
                        </select>
                        <button id="refresh-chunks-btn" class="btn btn-sm btn-outline-secondary me-2" title="Aggiorna Lista Chunk">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button id="generate-chunks-btn" class="btn btn-sm btn-info me-2" title="Genera Nuovi Chunk di Validazione">
                            <i class="fas fa-cogs"></i> Genera
                        </button>
                    </div>
                </div>
                <div class="list-group list-group-flush" id="chunk-list">
                    <!-- I chunk verranno caricati qui dinamicamente -->
                </div>
            </div>
        </div>
        
        <!-- Colonna destra: Dettagli chunk -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0" id="chunk-details-title">Dettagli Chunk</h5>
                </div>
                <div class="card-body">
                    <div id="chunk-details-empty" class="text-center p-3">
                        <p class="text-muted">Seleziona un chunk per visualizzare i dettagli</p>
                    </div>
                    <div id="chunk-details-content" class="d-none">
                        <!-- Informazioni di base -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>ID:</strong> <span id="chunk-id"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Stato:</strong> <span id="chunk-status" class="badge"></span>
                        </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Creato da:</strong> <span id="chunk-created-by"></span>
                        </div>
                            <div class="col-md-6">
                                <strong>Assegnato a:</strong> <span id="chunk-assigned-to"></span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <strong>Descrizione:</strong>
                            <p id="chunk-description" class="mb-0"></p>
                        </div>
                        
                        <!-- Dati del grafo -->
                        <div class="mb-3">
                            <h6>Dati del Grafo</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Nodi</th>
                                            <th>Relazioni</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td id="chunk-nodes-count">0</td>
                                            <td id="chunk-edges-count">0</td>
                                        </tr>
                                    </tbody>
                                </table>
                        </div>
                            <div id="chunk-data" class="border rounded p-2 bg-light">
                                <pre class="mb-0"><code id="chunk-data-json"></code></pre>
                            </div>
                        </div>
                        
                        <!-- Azioni -->
                        <div class="d-flex justify-content-end">
                            <button class="btn btn-danger me-2" id="delete-chunk-btn">
                                <i class="fas fa-trash"></i> Elimina
                            </button>
                            <a href="#" class="btn btn-primary" id="validate-chunk-btn">
                                <i class="fas fa-check"></i> Valida
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal per la generazione dei chunk -->
<div class="modal fade" id="generateChunksModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Genera Nuovi Chunks</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="generateChunksForm">
                    <div class="mb-3">
                        <label for="numChunks" class="form-label">Numero di chunks da generare</label>
                        <input type="number" class="form-control" id="numChunks" value="3" min="1" max="10">
                    </div>
                    <div class="mb-3">
                        <label for="seedLabel" class="form-label">Label dei nodi seed</label>
                        <select class="form-control" id="seedLabel">
                            <option value="Norma">Norma</option>
                            <option value="ConcettoGiuridico">Concetto Giuridico</option>
                            <option value="SoggettoGiuridico">Soggetto Giuridico</option>
                            <option value="AttoGiudiziario">Atto Giudiziario</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="forceRecreate">
                            <label class="form-check-label" for="forceRecreate">
                                Forza ricreazione (sovrascrive i chunk esistenti)
                        </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" id="confirmGenerateBtn">Genera</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { api } from "{{ url_for('static', filename='js/api.js') }}";
    import { showNotification, showLoading, hideLoading } from "{{ url_for('static', filename='js/ui.js') }}";
    
    // Stato dell'applicazione
    let chunks = [];
    let users = [];
    let currentChunkId = null;
    let deleteChunkModalInstance = null;
    let generateChunksModalInstance = null;
    
    // Inizializzazione della pagina
    document.addEventListener('DOMContentLoaded', () => {
        // Inizializza componenti
        initializeComponents();
        
        // Carica dati iniziali
        loadChunks();
        loadUsers();
        
        // Configura event listeners
        setupEventListeners();
    });
    
    // Inizializza componenti dell'interfaccia
    function initializeComponents() {
        const deleteChunkModalEl = document.getElementById('deleteChunkModal');
        if (deleteChunkModalEl) {
            deleteChunkModalInstance = new bootstrap.Modal(deleteChunkModalEl);
        }
        const generateChunksModalEl = document.getElementById('generateChunksModal');
        if (generateChunksModalEl) {
            generateChunksModalInstance = new bootstrap.Modal(generateChunksModalEl);
        }
    }
    
    // Configura gli event listeners
    function setupEventListeners() {
        // Pulsante per creare un nuovo chunk
        document.getElementById('create-new-chunk-btn')?.addEventListener('click', createNewChunk);
        
        // Form del chunk
        document.getElementById('chunk-form')?.addEventListener('submit', saveChunk);
        document.getElementById('cancel-chunk-btn')?.addEventListener('click', cancelChunkEdit);
        
        // Filtro per stato
        document.getElementById('chunk-status-filter')?.addEventListener('change', e => {
            loadChunks(e.target.value);
        });
        
        // Refresh button
        document.getElementById('refresh-chunks-btn')?.addEventListener('click', () => {
             const currentStatus = document.getElementById('chunk-status-filter')?.value || 'all';
             loadChunks(currentStatus);
        });
        
        // Assegnazione chunk
        document.getElementById('assign-chunk-btn')?.addEventListener('click', assignChunk);
        
        // Eliminazione chunk
        document.getElementById('delete-chunk-btn')?.addEventListener('click', showDeleteChunkModal);
        document.getElementById('confirm-delete-chunk-btn')?.addEventListener('click', deleteChunk);
        
        // Add listener for generate chunks button
        document.getElementById('generate-chunks-btn')?.addEventListener('click', showGenerateChunksModal);
        document.getElementById('confirm-generate-chunks-btn')?.addEventListener('click', generateChunks);
    }
    
    // Carica i chunk esistenti
    async function loadChunks(status = 'all') {
        try {
            showLoading();
            
            console.log(`Loading chunks with status=${status}`);
            const response = await api.getGraphChunks(status);
            
            if (response && response.status === 'success') {
                chunks = response.chunks || [];
                console.log('Chunks received from API:', chunks);
                renderChunkList();
            } else {
                showNotification('Errore nel caricamento dei chunk', 'danger');
            }
        } catch (error) {
            console.error('Error loading graph chunks:', error);
            showNotification(`Errore: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }
    
    // Renderizza la lista dei chunk
    function renderChunkList() {
        console.log('Rendering chunk list with data:', chunks);
        const chunkList = document.getElementById('chunk-list');
        if (!chunkList) {
             console.error('Element with ID \'chunk-list\' not found!');
             return;
        }
        
        if (chunks.length === 0) {
            chunkList.innerHTML = `
                <div class="text-center p-3">
                    <p class="text-muted">Nessun chunk disponibile</p>
                    <button id="first-chunk-btn" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-plus me-1"></i> Crea il primo chunk
                    </button>
                </div>
            `;
            
            document.getElementById('first-chunk-btn')?.addEventListener('click', createNewChunk);
            return;
        }
        
        chunkList.innerHTML = '';
        
        chunks.forEach((chunk, index) => {
             console.log(`Rendering chunk ${index}:`, chunk);
             if (!chunk || !chunk.id) {
                 console.warn(`Chunk at index ${index} is invalid or missing ID:`, chunk);
                 return;
             }
            const item = document.createElement('button');
            item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
            item.dataset.chunkId = chunk.id;
            
            // Aggiungi la classe active se è il chunk correntemente selezionato
            if (chunk.id === currentChunkId) {
                item.classList.add('active');
            }
            
            // Determina la classe di stato
            let statusBadgeClass = 'bg-secondary';
            if (chunk.status === 'validated') {
                statusBadgeClass = 'bg-success';
            } else if (chunk.status === 'rejected') {
                statusBadgeClass = 'bg-danger';
            }
            
            item.innerHTML = `
                <div>
                    <div>${chunk.title}</div>
                    <small class="text-muted">${chunk.chunk_type || 'subgraph'}</small>
                </div>
                <span class="badge ${statusBadgeClass}">${chunk.status}</span>
            `;
            
            item.addEventListener('click', () => selectChunk(chunk.id));
            
            chunkList.appendChild(item);
            console.log(`Appended item for chunk ${chunk.id}`);
        });
    }
    
    // Carica gli utenti disponibili
    async function loadUsers() {
        try {
            const response = await api.getUsers();
            
            if (response && response.status === 'success') {
                users = response.users || [];
                updateUserSelect();
            } else {
                console.error('Errore nel caricamento degli utenti');
            }
        } catch (error) {
            console.error('Error loading users:', error);
            showNotification(`Errore: ${error.message}`, 'danger');
        }
    }
    
    // Aggiorna la select degli utenti
    function updateUserSelect() {
        const userSelect = document.getElementById('assigned-to');
        if (!userSelect) return;
        
        userSelect.innerHTML = '<option value="">-- Seleziona annotatore --</option>';
        
        users.forEach(user => {
            // Filtriamo solo gli annotatori o admin
            if (user.role === 'annotator' || user.role === 'admin') {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.full_name || user.username;
                userSelect.appendChild(option);
            }
        });
    }
    
    // Seleziona un chunk esistente
    async function selectChunk(chunkId) {
        try {
            showLoading();
            
            // Aggiorna l'elemento attivo nella lista
            document.querySelectorAll('#chunk-list .list-group-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.chunkId === chunkId) {
                    item.classList.add('active');
                }
            });
            
            // Carica il chunk selezionato
            const response = await api.getGraphChunk(chunkId);
            
            if (response && response.status === 'success') {
                currentChunkId = chunkId;
                const chunk = response.chunk;
                
                // Popola il form con i dati del chunk
                document.getElementById('chunk-id').textContent = chunk.id;
                document.getElementById('chunk-status').textContent = chunk.status || 'pending';
                document.getElementById('chunk-status').className = `badge bg-${getStatusColor(chunk.status)}`;
                document.getElementById('chunk-created-by').textContent = chunk.created_by_username || chunk.created_by || 'N/A';
                document.getElementById('chunk-assigned-to').textContent = chunk.assigned_to_username || 'Non assegnato';
                document.getElementById('chunk-description').textContent = chunk.description || 'Nessuna descrizione';
                
                // Aggiorna i conteggi
                const nodesCount = chunk.data?.nodes?.length || 0;
                const edgesCount = chunk.data?.edges?.length || 0;
                document.getElementById('chunk-nodes-count').textContent = nodesCount;
                document.getElementById('chunk-edges-count').textContent = edgesCount;
                
                // Mostra i dati JSON formattati
                const jsonElement = document.getElementById('chunk-data-json');
                jsonElement.textContent = JSON.stringify(chunk.data, null, 2);
                
                // Aggiorna il link per la validazione
                const validateBtn = document.getElementById('validate-chunk-btn');
                validateBtn.href = `/knowledge_graph_validator?chunk_id=${chunk.id}`;
                
                // Mostra il form e la sezione assegnazione
                document.getElementById('chunk-details-empty').classList.add('d-none');
                document.getElementById('chunk-details-content').classList.remove('d-none');
                
                // Aggiorna la lista delle assegnazioni
                loadChunkAssignments(chunk.id);
            } else {
                showNotification('Errore nel caricamento del chunk', 'danger');
            }
        } catch (error) {
            console.error('Error selecting chunk:', error);
            showNotification(`Errore: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }
    
    // Carica le assegnazioni di un chunk
    async function loadChunkAssignments(chunkId) {
        try {
            const response = await api.getChunkAssignments(chunkId);
            
            if (response && response.status === 'success') {
                const assignments = response.assignments || [];
                renderAssignments(assignments);
            } else {
                console.error('Errore nel caricamento delle assegnazioni');
            }
        } catch (error) {
            console.error('Error loading chunk assignments:', error);
        }
    }
    
    // Renderizza le assegnazioni
    function renderAssignments(assignments) {
        const assignmentsList = document.getElementById('current-assignments');
        if (!assignmentsList) return;
        
        if (assignments.length === 0) {
            assignmentsList.innerHTML = '<p class="text-muted text-center">Nessuna assegnazione</p>';
            return;
        }
        
        assignmentsList.innerHTML = '';
        
        assignments.forEach(assignment => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            
            item.innerHTML = `
                <div>
                    <strong>${assignment.username}</strong>
                    <div><small class="text-muted">${formatDate(assignment.assigned_date)}</small></div>
                </div>
                <button class="btn btn-sm btn-outline-danger remove-assignment-btn" data-user-id="${assignment.user_id}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            const removeBtn = item.querySelector('.remove-assignment-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', () => removeAssignment(assignment.user_id));
            }
            
            assignmentsList.appendChild(item);
        });
    }
    
    // Mostra l'interfaccia per creare un nuovo chunk
    function createNewChunk() {
        // Reset del form
        document.getElementById('chunk-form').reset();
        document.getElementById('chunk-id').value = '';
        
        // Aggiunge un template JSON vuoto
        document.getElementById('chunk-data').value = JSON.stringify({
            "nodes": [
                {
                    "id": "node1",
                    "label": "Esempio Nodo",
                    "type": "concept"
                }
            ],
            "edges": [
                {
                    "id": "edge1",
                    "source": "node1",
                    "target": "node2",
                    "type": "relates_to"
                }
            ]
        }, null, 2);
        
        // Deseleziona tutti i chunk nella lista
        document.querySelectorAll('#chunk-list .list-group-item').forEach(item => {
            item.classList.remove('active');
        });
        
        currentChunkId = null;
        
        // Mostra il form e nasconde la sezione assegnazione
        document.getElementById('chunk-details-empty').classList.add('d-none');
        document.getElementById('chunk-form').classList.remove('d-none');
        document.getElementById('assignment-section-empty').classList.remove('d-none');
        document.getElementById('assignment-section').classList.add('d-none');
        
        // Imposta il focus sul campo titolo
        document.getElementById('chunk-title').focus();
    }
    
    // Salva un chunk (nuovo o esistente)
    async function saveChunk(event) {
        event.preventDefault();
        
        try {
            // Validazione dei dati
            const title = document.getElementById('chunk-title').value;
            const chunkType = document.getElementById('chunk-type').value;
            const jsonData = document.getElementById('chunk-data').value;
            
            // Verifica che il JSON sia valido
            let data;
            try {
                data = JSON.parse(jsonData);
            } catch (e) {
                showNotification('Il formato JSON non è valido', 'danger');
                return;
            }
            
            // Prepara i dati del chunk
            const chunkData = {
                id: document.getElementById('chunk-id').value || null,
                title: title,
                description: document.getElementById('chunk-description').value,
                chunk_type: chunkType,
                data: data,
                status: document.getElementById('chunk-status').value
            };
            
            showLoading();
            
            const response = await api.createGraphChunk(chunkData);
            
            if (response && response.status === 'success') {
                showNotification('Chunk salvato con successo', 'success');
                
                // Ricarica i chunk e seleziona quello appena salvato
                await loadChunks();
                if (response.chunk_id) {
                    selectChunk(response.chunk_id);
                }
            } else {
                showNotification('Errore nel salvataggio del chunk', 'danger');
            }
        } catch (error) {
            console.error('Error saving chunk:', error);
            showNotification(`Errore: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }
    
    // Annulla la modifica del chunk
    function cancelChunkEdit() {
        if (currentChunkId) {
            // Se stava modificando un chunk esistente, torna ai suoi dettagli
            selectChunk(currentChunkId);
        } else {
            // Se stava creando un nuovo chunk, nasconde il form
            document.getElementById('chunk-details-empty').classList.remove('d-none');
            document.getElementById('chunk-form').classList.add('d-none');
        }
    }
    
    // Assegna il chunk corrente a un utente
    async function assignChunk() {
        if (!currentChunkId) {
            showNotification('Nessun chunk selezionato', 'warning');
            return;
        }
        
        const userSelect = document.getElementById('assigned-to');
        const userId = userSelect.value;
        
        if (!userId) {
            showNotification('Seleziona un utente a cui assegnare il chunk', 'warning');
            return;
        }
        
        try {
            showLoading();
            
            const response = await api.assignGraphChunk(currentChunkId, userId);
            
            if (response && response.status === 'success') {
                showNotification('Chunk assegnato con successo', 'success');
                
                // Ricarica le assegnazioni
                loadChunkAssignments(currentChunkId);
                
                // Reset della select
                userSelect.value = '';
            } else {
                showNotification('Errore nell\'assegnazione del chunk', 'danger');
            }
        } catch (error) {
            console.error('Error assigning chunk:', error);
            showNotification(`Errore: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }
    
    // Rimuove un'assegnazione
    async function removeAssignment(userId) {
        if (!currentChunkId || !userId) return;
        
        try {
            showLoading();
            
            const response = await api.removeChunkAssignment(currentChunkId, userId);
            
            if (response && response.status === 'success') {
                showNotification('Assegnazione rimossa con successo', 'success');
                
                // Ricarica le assegnazioni
                loadChunkAssignments(currentChunkId);
            } else {
                showNotification('Errore nella rimozione dell\'assegnazione', 'danger');
            }
        } catch (error) {
            console.error('Error removing assignment:', error);
            showNotification(`Errore: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }
    
    // Mostra il modal di conferma eliminazione
    function showDeleteChunkModal() {
        if (!currentChunkId) return;
        
        const chunk = chunks.find(c => c.id === currentChunkId);
        if (!chunk) return;
        
        document.getElementById('chunk-name-to-delete').textContent = chunk.title;
        
        deleteChunkModalInstance.show();
    }
    
    // Elimina il chunk corrente
    async function deleteChunk() {
        if (!currentChunkId) return;
        
        try {
            showLoading();
            
            const response = await api.deleteGraphChunk(currentChunkId);
            
            if (response && response.status === 'success') {
                showNotification('Chunk eliminato con successo', 'success');
                
                // Chiudi il modal
                deleteChunkModalInstance.hide();
                
                // Reset della selezione e form
                currentChunkId = null;
                document.getElementById('chunk-form').reset();
                document.getElementById('chunk-details-empty').classList.remove('d-none');
                document.getElementById('chunk-form').classList.add('d-none');
                document.getElementById('assignment-section-empty').classList.remove('d-none');
                document.getElementById('assignment-section').classList.add('d-none');
                
                // Ricarica i chunk
                await loadChunks();
            } else {
                showNotification('Errore nell\'eliminazione del chunk', 'danger');
            }
        } catch (error) {
            console.error('Error deleting chunk:', error);
            showNotification(`Errore: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }
    
    // Formatta una data ISO in un formato leggibile
    function formatDate(dateString) {
        if (!dateString) return '';
        
        try {
            const date = new Date(dateString);
            return date.toLocaleString();
        } catch {
            return dateString;
        }
    }

    // Show modal to confirm chunk generation
    function showGenerateChunksModal() {
        document.getElementById('num-chunks-input').value = 10;
        document.getElementById('seed-label-input').value = 'Norma';
        document.getElementById('force-recreate-checkbox').checked = false;
        
        if (generateChunksModalInstance) {
            generateChunksModalInstance.show();
        } else {
            console.error("Generate chunks modal not initialized.");
        }
    }

    // Call the backend API to generate chunks
    async function generateChunks() {
        const numChunksInput = document.getElementById('num-chunks-input');
        const seedLabelInput = document.getElementById('seed-label-input');
        const forceRecreateCheckbox = document.getElementById('force-recreate-checkbox');

        const numChunks = parseInt(numChunksInput?.value || '10', 10);
        const seedLabel = seedLabelInput?.value || 'Norma';
        const forceRecreate = forceRecreateCheckbox?.checked || false;

        if (isNaN(numChunks) || numChunks <= 0) {
            showNotification('Inserisci un numero valido di chunk da generare.', 'warning');
            return;
        }
        if (!seedLabel) {
            showNotification('Inserisci una label valida per i nodi seed.', 'warning');
            return;
        }

        try {
            showLoading();
            showNotification('Avvio generazione chunk in background...', 'info');
            
            const response = await api.generateGraphChunks({
                num_chunks: numChunks,
                seed_label: seedLabel,
                force_recreate: forceRecreate
            });
            
            hideLoading();
            
            if (response && response.status === 'processing') {
                showNotification(response.message || 'Generazione chunk avviata in background. Aggiorna manualmente la lista tra poco.', 'info');
            } else if (response && response.status === 'success') {
                showNotification(response.message || 'Generazione chunk completata.', 'success');
                await loadChunks();
            } else {
                showNotification(response?.message || 'Errore nell\'avvio della generazione dei chunk', 'danger');
            }
        } catch (error) {
            hideLoading();
            console.error('Error generating chunks:', error);
            showNotification(`Errore API: ${error.message}`, 'danger');
        } finally {
            if (generateChunksModalInstance) {
                generateChunksModalInstance.hide();
            }
            hideLoading();
        }
    }

    // Funzioni di utilità
    function getStatusColor(status) {
        switch (status) {
            case 'validated':
            case 'applied':
                return 'success';
            case 'rejected':
            case 'failed':
                return 'danger';
            case 'pending':
                return 'warning';
            default:
                return 'secondary';
        }
    }
</script>
{% endblock %}